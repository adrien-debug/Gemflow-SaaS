name: Guard immutable deploy config

on:
  pull_request:
  push:
    branches: [main]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Guard deploy config (immutable)
        shell: bash
        run: |
          chmod +x scripts/guard-immutable-deploy-config.sh
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            # Compare PR head with its base branch
            git fetch --no-tags --prune origin "${GITHUB_BASE_REF}:${GITHUB_BASE_REF}"
            ./scripts/guard-immutable-deploy-config.sh "origin/${GITHUB_BASE_REF}" "HEAD"
          else
            # Compare pushed commit with previous commit
            ./scripts/guard-immutable-deploy-config.sh "${GITHUB_EVENT_BEFORE}" "${GITHUB_SHA}"
          fi

