<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                   https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

    <changeSet id="001_PURE_METAL_PURCHASE_CREATE" author="${author}">
        <sql dbms="${dbms}">
            CREATE TABLE public.pure_metal_purchase
            (
                id                  BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
                batch_weight        NUMERIC(11, 5)                          NOT NULL,
                remaining_weight    NUMERIC(11, 5)                          NOT NULL,
                bar_number          VARCHAR(255),
                coc                 VARCHAR(255),
                balance_date        DATE                                    NOT NULL,
                price_gram          NUMERIC(13, 3) GENERATED ALWAYS AS (batch_price / batch_weight) STORED NOT NULL,
                batch_price         NUMERIC(13, 3)                          NOT NULL,
                remaining_price     NUMERIC(13, 3) GENERATED ALWAYS AS (batch_price / batch_weight * remaining_weight) STORED NOT NULL,
                price_metal_name_id BIGINT                                  NOT NULL,
                supplier_id         BIGINT                                  NOT NULL,
                atelier_file_id     BIGINT
            );
        </sql>
        <addForeignKeyConstraint constraintName="fk_pure_metal_purchase__price_metal_name"
                                 baseTableName="pure_metal_purchase" baseColumnNames="price_metal_name_id"
                                 referencedTableName="price_metal_name" referencedColumnNames="id"/>

        <addForeignKeyConstraint constraintName="fk_pure_metal_purchase__supplier"
                                 baseTableName="pure_metal_purchase" baseColumnNames="supplier_id"
                                 referencedTableName="supplier" referencedColumnNames="id"/>

        <addForeignKeyConstraint constraintName="fk_pure_metal_purchase__atelier_file"
                                 baseTableName="pure_metal_purchase" baseColumnNames="atelier_file_id"
                                 referencedTableName="atelier_file" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="002_PURE_METAL_PURCHASE_CREATE" author="${author}">
        <sqlFile path="057_CREATE_UPDATE_PURE_METAL_SUMMARY_FUNCTION.sql" relativeToChangelogFile="true"
                 dbms="${dbms}"/>
    </changeSet>

    <changeSet id="003_PURE_METAL_PURCHASE_CREATE" author="${author}">
        <sql dbms="${dbms}">
            CREATE TRIGGER tr_pure_metal_purchase_insert
                AFTER INSERT
                ON public.pure_metal_purchase
                FOR EACH ROW
                EXECUTE FUNCTION update_pure_metal_summary();

            CREATE TRIGGER tr_pure_metal_purchase_update
                AFTER UPDATE
                ON public.pure_metal_purchase
                FOR EACH ROW
                EXECUTE FUNCTION update_pure_metal_summary();

            CREATE TRIGGER tr_pure_metal_purchase_delete
                AFTER DELETE
                ON public.pure_metal_purchase
                FOR EACH ROW
                EXECUTE FUNCTION update_pure_metal_summary();
        </sql>
    </changeSet>

    <changeSet id="004_PURE_METAL_PURCHASE_CREATE" author="${author}">
        <modifyDataType tableName="pure_metal_summary" columnName="remaining_weight"
                        newDataType="numeric(11, 5)"/>
    </changeSet>

    <changeSet id="005_PURE_METAL_PURCHASE_CREATE" author="${author}">
        <addColumn tableName="pure_metal_purchase">
            <column name="version" type="BIGINT" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="006_PURE_METAL_PURCHASE_CREATE" author="${author}">
        <sql dbms="${dbms}">
            ALTER TABLE pure_metal_purchase DROP COLUMN price_gram;
            ALTER TABLE pure_metal_purchase ADD COLUMN price_gram numeric(13, 3) DEFAULT 120 NOT NULL;

            ALTER TABLE pure_metal_purchase DROP COLUMN remaining_price;
            ALTER TABLE pure_metal_purchase ADD COLUMN remaining_price NUMERIC(13, 3) GENERATED ALWAYS AS (price_gram * remaining_weight) STORED NOT NULL;

            ALTER TABLE pure_metal_purchase DROP COLUMN batch_price;
            ALTER TABLE pure_metal_purchase ADD COLUMN batch_price NUMERIC(13, 3) GENERATED ALWAYS AS (price_gram * batch_weight) STORED NOT NULL;
        </sql>
    </changeSet>

</databaseChangeLog>